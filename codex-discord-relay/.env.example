# Discord bot token from Discord Developer Portal
DISCORD_BOT_TOKEN=

# Agent backend: "codex" (default) or "claude"
RELAY_AGENT_PROVIDER=codex

# Optional: codex binary path
CODEX_BIN=codex
# Optional: claude binary path (used when RELAY_AGENT_PROVIDER=claude)
CLAUDE_BIN=claude
# Max runtime per agent invocation in milliseconds (set 0 to disable timeout)
RELAY_AGENT_TIMEOUT_MS=600000

# Default working directory for Codex sessions
CODEX_WORKDIR=/root

# Restrict /workdir command to these roots (comma-separated)
CODEX_ALLOWED_WORKDIR_ROOTS=/root

# Optional: model override (empty = codex default)
CODEX_MODEL=
# Optional: model override for Claude (empty = claude default)
CLAUDE_MODEL=
# Optional: Claude permission mode.
# If relay runs as root, use acceptEdits (bypassPermissions is blocked under root).
# Examples: acceptEdits, default, delegate, plan
CLAUDE_PERMISSION_MODE=

# Sandbox and approval behavior
CODEX_SANDBOX=danger-full-access
# Approval policy is configured via Codex config (approval_policy). Common values: never, on-request
CODEX_APPROVAL=never
# Optional explicit alias (preferred name)
CODEX_APPROVAL_POLICY=

# Enable web search and skip git repo check when needed
CODEX_ENABLE_SEARCH=true
CODEX_SKIP_GIT_REPO_CHECK=true

# Optional codex config overrides, semicolon-separated
# Example: model_provider="openai";model_reasoning_effort="high"
CODEX_CONFIG_OVERRIDES=

# Relay runtime paths
RELAY_STATE_DIR=/root/.codex-discord-relay
RELAY_STATE_FILE=/root/.codex-discord-relay/sessions.json
RELAY_MAX_REPLY_CHARS=1800
RELAY_ATTACH_ALLOW_GUILDS=false

# Optional allowlists (comma-separated IDs)
DISCORD_ALLOWED_GUILDS=
DISCORD_ALLOWED_CHANNELS=

# Thread behavior
# When true, in guild threads the bot will respond without requiring an @mention.
# Default: true if DISCORD_ALLOWED_CHANNELS is set; otherwise false.
# RELAY_THREAD_AUTO_RESPOND=true

# Task queue (Ralph loop)
RELAY_TASKS_ENABLED=true
RELAY_TASKS_MAX_PENDING=50
RELAY_TASKS_STOP_ON_ERROR=false
RELAY_TASKS_POST_FULL_OUTPUT=true
# Post a short summary message after /task runner stops.
RELAY_TASKS_SUMMARY_AFTER_RUN=true

# Priority question interrupts
# `/ask <question...>` bypasses queue, pauses active run if possible, answers, then resumes.
RELAY_INTERRUPT_QUESTIONS_ENABLED=true
# If true, queued plain-text questions ending with '?' are auto-routed through interrupt mode.
RELAY_INTERRUPT_QUESTIONS_AUTO=false
RELAY_INTERRUPT_QUESTIONS_TIMEOUT_MS=180000
# Sandbox for priority-question runs (codex provider).
RELAY_INTERRUPT_QUESTIONS_SANDBOX=read-only
# Relay-built snapshot context injected into /ask prompts.
RELAY_INTERRUPT_QUESTIONS_SNAPSHOT_MAX_CHARS=18000
RELAY_INTERRUPT_QUESTIONS_SNAPSHOT_PROGRESS_LINES=40
RELAY_INTERRUPT_QUESTIONS_SNAPSHOT_LOG_MAX_BYTES=2097152
RELAY_INTERRUPT_QUESTIONS_SNAPSHOT_LOG_MAX_CHARS=12000

# Git worktrees
# Default: $RELAY_STATE_DIR/worktrees (must be under CODEX_ALLOWED_WORKDIR_ROOTS).
# RELAY_WORKTREE_ROOT_DIR=$RELAY_STATE_DIR/worktrees

# Agent relay actions (agent -> relay automation)
# Allows the agent to request privileged relay-side actions by outputting:
#   [[relay-actions]]{"actions":[...]}[[/relay-actions]]
# Disabled by default for safety; DM-only by default.
RELAY_AGENT_ACTIONS_ENABLED=false
RELAY_AGENT_ACTIONS_DM_ONLY=true
RELAY_AGENT_ACTIONS_ALLOWED=job_start,job_stop,job_watch
RELAY_AGENT_ACTIONS_MAX_PER_MESSAGE=1
# Maximum shell command length accepted for job_start.
RELAY_MAX_JOB_COMMAND_CHARS=12000

# Jobs auto-watch defaults (used when relay actions start/watch a job).
# Default is true only when actions are enabled.
RELAY_JOBS_AUTO_WATCH=true
RELAY_JOBS_AUTO_WATCH_EVERY_SEC=300
RELAY_JOBS_AUTO_WATCH_TAIL_LINES=30
# Exp command family (/exp run|best|report)
RELAY_EXP_COMMANDS_ENABLED=true
RELAY_EXP_ALLOW_GUILDS=true
RELAY_EXP_DEFAULT_READY_TIMEOUT_SEC=900
RELAY_EXP_DEFAULT_READY_POLL_SEC=15
RELAY_EXP_EXPERIENCE_LOGGING_ENABLED=true
RELAY_EXP_WATCH_SNAPSHOTS_ENABLED=false
RELAY_EXP_WATCH_SNAPSHOT_EVERY_SEC=300
RELAY_EXP_WATCH_SNAPSHOT_TAIL_LINES=80
# /go long-task auto-wrap watcher defaults.
RELAY_GO_AUTOWRAP_LONG_TASKS=true
RELAY_GO_LONG_TASK_WATCH_EVERY_SEC=300
RELAY_GO_LONG_TASK_TAIL_LINES=30
# Watcher message compactness controls.
RELAY_JOBS_WATCH_COMPACT=true
RELAY_JOBS_WATCH_POST_NO_CHANGE=false
RELAY_JOBS_WATCH_INCLUDE_TAIL_ON_CHANGE=false
RELAY_JOBS_WATCH_INCLUDE_TAIL_ON_FINISH=false
RELAY_JOBS_WATCH_COMPACT_TAIL_LINES=3
RELAY_JOBS_WATCH_COMPACT_TAIL_MAX_CHARS=600
# Watch Contract v2 gates (disabled by default for safe rollout)
RELAY_WATCH_REQUIRE_FILES_ENABLED=false
RELAY_WATCH_REQUIRE_FILES_DEFAULT_TIMEOUT_SEC=900
RELAY_WATCH_REQUIRE_FILES_DEFAULT_POLL_SEC=15
# Relay-native supervisor Phase 1 (disabled by default; validates stage0 smoke-gate contracts)
# By default relay uses its bundled stage0 runner under codex-discord-relay/scripts.
# Relative override paths are resolved against supervisor cwd, then relay dir fallback.
RELAY_SUPERVISOR_PHASE1_ENABLED=false
RELAY_SUPERVISOR_PHASE1_DEFAULT_SCRIPT=scripts/stage0_smoke_gate.py
RELAY_SUPERVISOR_PHASE1_DEFAULT_EXPECT_STATUS=success
RELAY_SUPERVISOR_PHASE1_DEFAULT_READY_TIMEOUT_SEC=900
RELAY_SUPERVISOR_PHASE1_DEFAULT_READY_POLL_SEC=15
# Launch preflight + wait-pattern safety
RELAY_JOB_PREFLIGHT_ENABLED=false
RELAY_WAIT_PATTERN_GUARD_MODE=warn
# Visibility SLO gate for long jobs
RELAY_VISIBILITY_GATE_ENABLED=false
RELAY_VISIBILITY_STARTUP_HEARTBEAT_SEC=60
RELAY_VISIBILITY_HEARTBEAT_EVERY_SEC=600
# Stale-progress guard: only alert when run log is unchanged and utilization stays low.
RELAY_WATCH_STALE_GUARD_ENABLED=true
RELAY_WATCH_STALE_MINUTES=15
RELAY_WATCH_STALE_ALERT_EVERY_MINUTES=30
RELAY_WATCH_STALE_CPU_LOW_PCT=20
RELAY_WATCH_STALE_GPU_LOW_PCT=20

# Research manager (/research)
# Disabled by default; DM-only by default.
RELAY_RESEARCH_ENABLED=false
RELAY_RESEARCH_DM_ONLY=true
# Must be under CODEX_ALLOWED_WORKDIR_ROOTS.
RELAY_RESEARCH_PROJECTS_ROOT=/root/.codex-discord-relay/projects
RELAY_RESEARCH_DEFAULT_MAX_STEPS=50
RELAY_RESEARCH_DEFAULT_MAX_WALLCLOCK_MIN=480
RELAY_RESEARCH_DEFAULT_MAX_RUNS=30
RELAY_RESEARCH_TICK_SEC=30
RELAY_RESEARCH_LEASE_TTL_SEC=300
RELAY_RESEARCH_MAX_ACTIONS_PER_STEP=12
RELAY_RESEARCH_REQUIRE_NOTE_PREFIX=false
# Research actions are independent from RELAY_AGENT_ACTIONS_ALLOWED.
RELAY_RESEARCH_ACTIONS_ALLOWED=job_start,job_watch,job_stop,task_add,task_run,write_report,research_pause,research_mark_done

# Tooling defaults for experiment registry writes.
RELAY_REGISTRY_LOCK_ENABLED=true

# Plans
# /plan <request...> generates a plan with `codex exec --sandbox read-only` (stateless) and saves it to disk.
RELAY_PLANS_ENABLED=true
RELAY_PLANS_MAX_HISTORY=20
# For safety, require explicit confirmation when applying plans in guild channels.
RELAY_PLAN_APPLY_REQUIRE_CONFIRM_IN_GUILDS=true

# Handoff + working memory
# /handoff appends a generated entry into these files (semicolon-separated; relative to repo root when in a git repo).
RELAY_HANDOFF_ENABLED=true
RELAY_HANDOFF_FILES="HANDOFF_LOG.md;docs/WORKING_MEMORY.md"
# Legacy knob: if true, automatically write a /handoff after task runs and plan applies.
RELAY_HANDOFF_AUTO_ENABLED=false
# Preferred knobs:
RELAY_AUTO_HANDOFF_AFTER_EACH_TASK=false
RELAY_AUTO_HANDOFF_AFTER_TASK_RUN=false
RELAY_AUTO_HANDOFF_AFTER_PLAN_APPLY=false
# Optional: auto-commit/push the handoff files after writing (git repos only).
RELAY_HANDOFF_GIT_AUTO_COMMIT=false
RELAY_HANDOFF_GIT_AUTO_PUSH=false
RELAY_HANDOFF_GIT_COMMIT_MESSAGE="chore: relay handoff"

# Optional: auto-commit arbitrary repo changes after successful tasks/plan apply (never auto-push).
RELAY_GIT_AUTO_COMMIT=false
RELAY_GIT_AUTO_COMMIT_SCOPE=both
# Values: task|plan|both
RELAY_GIT_COMMIT_PREFIX="ai:"

# Progress updates in Discord while a run is in-flight.
RELAY_PROGRESS=true
RELAY_PROGRESS_MIN_EDIT_MS=5000
RELAY_PROGRESS_HEARTBEAT_MS=20000
RELAY_PROGRESS_MAX_LINES=6
# If true, include command text in progress lines (may leak sensitive args).
RELAY_PROGRESS_SHOW_COMMANDS=false
# Optional fine-grained run telemetry (off by default to avoid log noise).
RELAY_PROGRESS_TRACE_ENABLED=false
RELAY_PROGRESS_TRACE_INCLUDE_SYNTHETIC=false
RELAY_PROGRESS_TRACE_MAX_CHARS=220
# Optional persistent milestone posts (survive message edits; throttled).
RELAY_PROGRESS_PERSISTENT_ENABLED=false
RELAY_PROGRESS_PERSISTENT_EVERY_MS=45000
RELAY_PROGRESS_PERSISTENT_ORCHESTRATOR_EVERY_MS=15000
RELAY_PROGRESS_PERSISTENT_MAX_PER_RUN=6
# Selective durability mode for persistent updates:
# - all: keep prior behavior (any non-synthetic progress note can persist)
# - narrative: persist only higher-signal narrative notes; keep command/tool traces transient
# - narrative+milestones: narrative plus explicit relay milestone summaries
# - narrative+milestones+orchestrator: plus "Thinking: ..." style orchestrator updates
# - off: disable durable progress notes even if RELAY_PROGRESS_PERSISTENT_ENABLED=true
RELAY_PROGRESS_PERSISTENT_MODE=narrative+milestones+orchestrator
RELAY_PROGRESS_PERSISTENT_MIN_CHARS=32
RELAY_PROGRESS_PERSISTENT_MAX_CHARS=320

# Agent context bootstrap
# Inject relay runtime context into agent prompts so Claude/Codex understands Discord routing,
# upload markers, and relay command boundaries.
RELAY_CONTEXT_ENABLED=true
# If false, inject only when session context version is behind target version.
RELAY_CONTEXT_EVERY_TURN=false
# Increase this number to force a one-time re-bootstrap for all existing sessions.
RELAY_CONTEXT_VERSION=1
# Optional semicolon-separated context specs.
# Prefix supported per item: head:, tail:, headtail:
# Relative paths resolve against session workdir.
RELAY_CONTEXT_FILE="/root/.codex-discord-relay/global-context.md;tail:docs/WORKING_MEMORY.md;tail:HANDOFF_LOG.md;tail:/root/SYSTEM_SETUP_WORKING_MEMORY.md;tail:/root/HANDOFF_LOG.md"
RELAY_CONTEXT_MAX_CHARS=40000
RELAY_CONTEXT_MAX_CHARS_PER_FILE=20000

# Incoming Discord attachments (small text files)
# If enabled, the relay downloads small text attachments into:
#   <upload_dir>/attachments/
# and appends their contents to the prompt automatically.
# Optional: enable guarded .zip ingest to extract text-like entries only.
RELAY_DISCORD_ATTACHMENTS_ENABLED=true
RELAY_DISCORD_ATTACHMENTS_MAX_FILES=3
RELAY_DISCORD_ATTACHMENTS_MAX_BYTES=262144
RELAY_DISCORD_ATTACHMENTS_MAX_CHARS=20000
RELAY_DISCORD_ATTACHMENTS_MAX_CHARS_PER_FILE=8000
RELAY_DISCORD_ATTACHMENTS_DOWNLOAD_TIMEOUT_MS=15000
RELAY_DISCORD_ATTACHMENTS_ZIP_ENABLED=false
RELAY_DISCORD_ATTACHMENTS_ZIP_MAX_ENTRIES=10
RELAY_DISCORD_ATTACHMENTS_ZIP_MAX_BYTES=8388608
RELAY_DISCORD_ATTACHMENTS_ZIP_MAX_ENTRY_BYTES=131072
RELAY_DISCORD_ATTACHMENTS_ZIP_MAX_CHARS_PER_ENTRY=4000
RELAY_DISCORD_ATTACHMENTS_ZIP_EXTRACT_TIMEOUT_MS=20000
# Comma-separated extension allowlist for zip-entry extraction.
RELAY_DISCORD_ATTACHMENTS_ZIP_ALLOWED_EXTS=.txt,.md,.markdown,.json,.yaml,.yml,.toml,.csv,.tsv,.log,.env,.ini,.cfg,.conf,.xml,.html,.css,.js,.ts,.py,.sh,.bash,.zsh,.patch,.diff,.rst,.sql,.proto,.properties,.ps1,.bat,.cmd,.dockerfile,.gitignore

# Uploads (file attachments)
# If enabled, Codex can request file uploads by including markers like:
#   [[upload:plot.png]]
# Discord will usually render images inline and keep non-image files downloadable.
# Paths are resolved relative to a per-conversation upload directory under RELAY_UPLOAD_ROOT_DIR
# (defaults to $RELAY_STATE_DIR/uploads).
RELAY_UPLOAD_ENABLED=true
# RELAY_UPLOAD_ROOT_DIR=/root/.codex-discord-relay/uploads
RELAY_UPLOAD_MAX_FILES=3
RELAY_UPLOAD_MAX_BYTES=8388608
# By default, uploads are restricted to the per-conversation upload_dir. If you set this true,
# you must also set RELAY_UPLOAD_ALLOWED_ROOTS safely (or it will default to RELAY_UPLOAD_ROOT_DIR).
RELAY_UPLOAD_ALLOW_OUTSIDE_CONVERSATION=false
RELAY_UPLOAD_ALLOWED_ROOTS=

# Optional: proxy for Discord connectivity (esp. restricted networks).
# Note: the ensure script also sources /root/.openclaw/proxy.env if present.
DISCORD_GATEWAY_PROXY=
