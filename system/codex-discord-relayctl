#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${CODEX_RELAY_STATE_DIR:-/root/.codex-discord-relay}"
PID_FILE="$STATE_DIR/relay.pid"
LOG_FILE="$STATE_DIR/relay.log"
ENSURE="/usr/local/bin/codex-discord-relay-ensure.sh"

usage() {
  cat <<USAGE
Usage: codex-discord-relayctl {start|restart|stop|status|logs}
USAGE
}

running_pid() {
  if [[ -f "$PID_FILE" ]]; then
    pid="$(cat "$PID_FILE" 2>/dev/null || true)"
    if [[ "$pid" =~ ^[0-9]+$ ]] && kill -0 "$pid" 2>/dev/null; then
      echo "$pid"
      return 0
    fi
  fi
  app_dir="${CODEX_RELAY_APP_DIR:-/root/codex-discord-relay}"
  pid="$(ps -eo pid=,args= | awk -v p=\"$app_dir/relay.js\" 'index($0,p)>0 {print $1; exit}')"
  if [[ -n "$pid" ]]; then
    echo "$pid" > "$PID_FILE"
    echo "$pid"
    return 0
  fi
  return 1
}

cmd="${1:-status}"
case "$cmd" in
  start)
    "$ENSURE"
    echo "relay started/healthy"
    ;;
  restart)
    if pid="$(running_pid)"; then
      kill "$pid" || true
      sleep 1
    fi
    "$ENSURE"
    echo "relay restarted"
    ;;
  stop)
    if pid="$(running_pid)"; then
      kill "$pid" || true
      rm -f "$PID_FILE"
      echo "relay stopped"
    else
      echo "relay not running"
    fi
    ;;
  status)
    if pid="$(running_pid)"; then
      echo "relay running pid=$pid"
    else
      echo "relay not running"
      exit 1
    fi
    ;;
  logs)
    tail -n 80 "$LOG_FILE"
    ;;
  *)
    usage
    exit 2
    ;;
esac
